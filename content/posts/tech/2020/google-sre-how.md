---
title: "Google SRE 运维解密笔记"
date: 2020-09-23T11:00:43+08:00
tags:
  - Google
  - SRE
  - notes
categories:
  -
---

本书对于 SRE 的定义

> 我们认为如果软件工程师主要专注于设计和构建软件系统，那么应该有另外一种职业专注于整个软件系统的生命周期管理。从其设计一直到部署，历经不断改进，最后顺利退役。这样一种职业必须具备非常广泛的技能，但是和其他职业的专注点都不同。Google 将这个职业称为站点可靠性工程师(SRE: Site Reliability Engineering)。

"无论对一个软件系统运行原理掌握得多么彻底，也不能阻止人犯意外错误。"

**只有靠着对细节的不懈关注，做好充足的灾难预案和准备工作，时刻警惕着，不放过一切机会去避免灾难发生。这就是 SRE 最重要的理念！**

## 介绍

> 不能将碰运气当成战略。 - SRE 俗语

SRE 团队要承担以下几类职责

- 可用性改进
- 延迟优化
- 性能优化
- 效率优化
- 变更管理
- 监控
- 紧急事务处理
- 容量规划与管理

### 在保障服务 SLO 的前提下最大化迭代速度

在企业中，最主要的矛盾就是迭代创新的速度与产品稳定程度之间的矛盾。
在 SRE 模型中，我们选择正面面对这种矛盾，使用的工具是`错误预算`。

> "错误预算"起源于这样一个理念： 任何产品都不是，也不应该做到 100%可靠(显然这并不适用于心脏起博器和防抱死系统等)。因为对最终用户来说，99.999%和 100%的可用性是没有实质区别的。

多少才是？

- 基于用户的使用习惯，服务可靠性要达到什么程度用户才会满意？
- 如果这项服务的可靠程度不够，用户是否有其他的替代选择？
- 服务的可靠程度是否会影响用户对这项服务的使用模式？

如果一个服务的可靠性目标是 99.99%，那么错误预算就是 0.01%。这意味着产品研发部门和 SRE 部门可以在这个范围内将预算用于新功能上线或产品创新等任何事情。

### 监控系统

监控系统是 SRE 团队监控服务质量和可用性的一个主要手段。

> 一个需要人工阅读邮件和分析警报来决定目前是否需要采取某种行动的系统本质上就是错误的。监控系统不应该依赖人来分析警报信息，而是应该由系统自动分析，仅当需要用户执行某种操作时，才需要通知用户。

一个监控系统应该只有三类输出

- 紧急警报 - alert
  > 意味着收到警报的用户需要立即执行某种操作，目标是解决某种已经发生的问题，或者是避免即将发生的问题。
- 工单 - ticket
  > 意味着接受工单的用户应该执行某种操作，但是并非立即执行。系统并不能自动解决目前的情况，但是如果一个用户在几天内执行这项操作，系统不会受到任何影响。
- 日志 - logging
  > 平时没有人需要关注日志信息，但是日志信息依然被收集起来以备调试和事后分析时使用。正确的做法是平时没人会去主动阅读日志，除非有特殊需要。

### 变更管理

大概 70%的生产事故由某种部署的变更而触发。变更管理的最佳实践是使用自动化来完成以下几个项目

- 采用渐进式发布机制
- 迅速而准确地检测到问题的发生
- 当出现问题时，安全迅速地回退改动

### 需求预测和容量规划

自然增长 - 随着用户使用量上升，资源用量也上升。
非自然增长 - 新功能的发布、商业推广以及其他商业因素在内。

容量规划有几个步骤是必需的

- 必须有一个准确的自然增长需求预测模型，需求预测的时间应该超过资源获取的时间
- 规划中必须有准确的非自然增长的需求来源的统计
- 必须有周期性压力测试，以便准确地将系统原始资源信息与业务容量对应起来

## Google 生产环境： SRE 视角

为了区分物理服务器和软件服务器的概念，本书采用以下两种说法

- 物理服务器 - machine
  > 代表具体的硬件(有时候也代表一个 VM 虚拟机)
- 软件服务器 - server
  > 代表一个对外提供服务的软件系统

一个典型的 Google 数据中心的拓扑结构

- 约 10 台物理服务器组成一个`机柜 - Rack`
- 数台机柜组成一个机柜`排 - Row`
- 一排或多排机柜组成了一个`集群 - Cluster`
- 一般来说，一个`数据中心 - Datacenter`包含多个集群
- 多个相邻的数据中心组成了一个`园区 - Campus`

### 存储

- Lustre
- HDFS

### 网络

带宽控制器(Bandwidth Enforcer， BwE)负责管理所有可用带宽。优化带宽的使用的目的不仅仅是降低成本。利用中心化的路由计算，可以解决以前在分布式路由模式下难以解决的流量迁移问题。

### 研发环境

除了一些开源项目之外(Android 和 Chrome 等)，其他 Google 软件工程师全部使用同一个共享软件仓库开发。这同时也对日常工作流带来一些挑战

- 如果一个工程师遇到了他工作的项目之外的一个基础组件问题，他可以直接修改这个问题，向管理者提交一份改动申请(changelist, CL)，等待代码评审，最后直接提交。
- 任何对自己项目代码的改动也需要代码评审。

### 任务和数据的组织方式

假设压力测试的结果现实，我们的软件服务器可以每秒处理大概 100 个请求(100 QPS)。通过对用户进行的调查显示，我们预计峰值流量会达到 3470 QPS，为了处理这些流量，至少需要 35 个任务实例。但是，由于以下几点考量，我们最终决定至少采用 37 个实例，也就是`N+2`模式

- 在更新过程中，有一个任务实例将会短暂不可用，只有 36 个实例可提供服务。
- 如果另外一个物理服务器同时也出现问题，那么另外一个任务实例也受到影响，只剩 35 个实例可以对外服务，刚好可以满足峰值要求。

<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=theme-color content=#494f5c><meta name=msapplication-TileColor content=#494f5c><meta itemprop=name content="Linux Xen和OpenVZ架构安装PPTP VPN。"><meta itemprop=description content="之前有好几次安装VPN服务都失败了，最近再次有安装几次发现非常的简单，特写此文章供参考。
Xen系统环境：CentOS release 6.4 (Final) 64位 首先检查是否支持PPP（一般都支持的） 执行modprobe ppp-compress-18 无返回结果则OK
[root@localhost ~]# modprobe ppp-compress-18 [root@localhost ~]#  下载pptp安装包
官方: (http://poptop.sourceforge.net/yum/stable/packages/) （需翻X）
[root@localhost ~]# ls pptpd-1.3.4-2.el6.x86_64.rpm [root@localhost ~]# rpm -ivh pptpd-1.3.4-2.el6.x86_64.rpm warning: pptpd-1.3.4-2.el6.x86_64.rpm: Header V3 DSA/SHA1 Signature, key ID 862acc42: NOKEY error: Failed dependencies: /usr/bin/perl is needed by pptpd-1.3.4-2.el6.x86_64 perl(strict) is needed by pptpd-1.3.4-2.el6.x86_64  执行安装的时候出现如上错误，原因是没有安装perl
yum -y install perl  
编辑ppp配置文件：vim /etc/ppp/options.pptpd
先按键盘上的 dG 清空默认配置添加下面的配置上去保存退出。
name pptpd refuse-pap refuse-chap refuse-mschap require-mschap-v2 require-mppe-128 proxyarp lock nobsdcomp novj novjccomp nologfd ms-dns 8."><meta itemprop=datePublished content=2013-08-14T14:25:05&#43;00:00><meta itemprop=dateModified content=2013-08-14T14:25:05&#43;00:00><meta itemprop=wordCount content=291><meta itemprop=keywords content=CentOS,Linux,OpenVZ,VPN,Xen,安装pptp,><meta property=og:title content="Linux Xen和OpenVZ架构安装PPTP VPN。"><meta property=og:description content="之前有好几次安装VPN服务都失败了，最近再次有安装几次发现非常的简单，特写此文章供参考。
Xen系统环境：CentOS release 6.4 (Final) 64位 首先检查是否支持PPP（一般都支持的） 执行modprobe ppp-compress-18 无返回结果则OK
[root@localhost ~]# modprobe ppp-compress-18 [root@localhost ~]#  下载pptp安装包
官方: (http://poptop.sourceforge.net/yum/stable/packages/) （需翻X）
[root@localhost ~]# ls pptpd-1.3.4-2.el6.x86_64.rpm [root@localhost ~]# rpm -ivh pptpd-1.3.4-2.el6.x86_64.rpm warning: pptpd-1.3.4-2.el6.x86_64.rpm: Header V3 DSA/SHA1 Signature, key ID 862acc42: NOKEY error: Failed dependencies: /usr/bin/perl is needed by pptpd-1.3.4-2.el6.x86_64 perl(strict) is needed by pptpd-1.3.4-2.el6.x86_64  执行安装的时候出现如上错误，原因是没有安装perl
yum -y install perl  
编辑ppp配置文件：vim /etc/ppp/options.pptpd
先按键盘上的 dG 清空默认配置添加下面的配置上去保存退出。
name pptpd refuse-pap refuse-chap refuse-mschap require-mschap-v2 require-mppe-128 proxyarp lock nobsdcomp novj novjccomp nologfd ms-dns 8."><meta property=og:type content=article><meta property=og:url content=https://painso.com/posts/tech/2013/linux-xen-openvz-pptp-services/><meta property=article:published_time content=2013-08-14T14:25:05+00:00><meta property=article:modified_time content=2013-08-14T14:25:05+00:00><meta name=twitter:card content=summary><meta name=twitter:title content="Linux Xen和OpenVZ架构安装PPTP VPN。"><meta name=twitter:description content="之前有好几次安装VPN服务都失败了，最近再次有安装几次发现非常的简单，特写此文章供参考。
Xen系统环境：CentOS release 6.4 (Final) 64位 首先检查是否支持PPP（一般都支持的） 执行modprobe ppp-compress-18 无返回结果则OK
[root@localhost ~]# modprobe ppp-compress-18 [root@localhost ~]#  下载pptp安装包
官方: (http://poptop.sourceforge.net/yum/stable/packages/) （需翻X）
[root@localhost ~]# ls pptpd-1.3.4-2.el6.x86_64.rpm [root@localhost ~]# rpm -ivh pptpd-1.3.4-2.el6.x86_64.rpm warning: pptpd-1.3.4-2.el6.x86_64.rpm: Header V3 DSA/SHA1 Signature, key ID 862acc42: NOKEY error: Failed dependencies: /usr/bin/perl is needed by pptpd-1.3.4-2.el6.x86_64 perl(strict) is needed by pptpd-1.3.4-2.el6.x86_64  执行安装的时候出现如上错误，原因是没有安装perl
yum -y install perl  
编辑ppp配置文件：vim /etc/ppp/options.pptpd
先按键盘上的 dG 清空默认配置添加下面的配置上去保存退出。
name pptpd refuse-pap refuse-chap refuse-mschap require-mschap-v2 require-mppe-128 proxyarp lock nobsdcomp novj novjccomp nologfd ms-dns 8."><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color><link rel="shortcut icon" href=/favicon.ico><title>Linux Xen和OpenVZ架构安装PPTP VPN。</title><link rel=stylesheet href=https://painso.com/css/style.min.5ee5e7976cd09872c64e40a582206543f6aa38c69a8c43898aadc70040344b92.css integrity="sha256-XuXnl2zQmHLGTkClgiBlQ/aqOMaajEOJiq3HAEA0S5I=" crossorigin=anonymous></head><body id=page><header id=site-header class="animated slideInUp faster"><div class="hdr-wrapper section-inner"><div class=hdr-left><div class=site-branding><a href=https://painso.com>ephz3nt</a></div><nav class="site-nav hide-in-mobile"><a href=https://painso.com/posts/>Posts</a>
<a href=https://painso.com/about-me/>About</a></nav></div><div class="hdr-right hdr-icons"><span class="hdr-social hide-in-mobile"><a href=https://github.com/ephz3nt target=_blank rel="noopener me" title=Github><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0 0 20 4.77 5.07 5.07.0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38.0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 0 0 5 4.77a5.44 5.44.0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 0 0 9 18.13V22"/></svg></a></span><button id=menu-btn class=hdr-btn><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><path d="M3 12H21z"/><path d="M3 6H21z"/><path d="M3 18H21z"/></svg></button></div></div></header><div id=mobile-menu class="animated fast"><ul><li><a href=https://painso.com/posts/>Posts</a></li><li><a href=https://painso.com/about-me/>About</a></li></ul></div><main class="site-main section-inner animated fadeIn faster"><article class=thin><header class=post-header><div class=post-meta><span>Aug 14, 2013</span></div><h1>Linux Xen和OpenVZ架构安装PPTP VPN。</h1></header><div class=content><p>之前有好几次安装VPN服务都失败了，最近再次有安装几次发现非常的简单，特写此文章供参考。</p><p>Xen系统环境：CentOS release 6.4 (Final) 64位
首先检查是否支持PPP（一般都支持的）
执行modprobe ppp-compress-18 无返回结果则OK</p><pre><code>[root@localhost ~]# modprobe ppp-compress-18
[root@localhost ~]#
</code></pre><p>下载pptp安装包</p><p>官方: (<a href=http://poptop.sourceforge.net/yum/stable/packages/>http://poptop.sourceforge.net/yum/stable/packages/</a>) （需翻X）</p><pre><code>[root@localhost ~]# ls
pptpd-1.3.4-2.el6.x86_64.rpm
[root@localhost ~]# rpm -ivh pptpd-1.3.4-2.el6.x86_64.rpm 
warning: pptpd-1.3.4-2.el6.x86_64.rpm: Header V3 DSA/SHA1 Signature, key ID 862acc42: NOKEY
error: Failed dependencies:
/usr/bin/perl is needed by pptpd-1.3.4-2.el6.x86_64
perl(strict) is needed by pptpd-1.3.4-2.el6.x86_64
</code></pre><p>执行安装的时候出现如上错误，原因是没有安装perl</p><pre><code>yum -y install perl
</code></pre><p><a href=/images/2013/08/install-perl.png><img src=/images/2013/08/install-perl-300x201.png alt=install-perl></a></p><p>编辑ppp配置文件：vim /etc/ppp/options.pptpd</p><p>先按键盘上的 dG 清空默认配置添加下面的配置上去保存退出。</p><pre><code>name pptpd 
refuse-pap 
refuse-chap 
refuse-mschap 
require-mschap-v2 
require-mppe-128 
proxyarp 
lock 
nobsdcomp 
novj 
novjccomp 
nologfd 
ms-dns 8.8.8.8
ms-dns 8.8.4.4
</code></pre><p>编辑IP地址池等信息：vim /etc/pptpd.conf</p><p>同样键入dG清空默认配置添加下方配置保存退出。（localip和remoteip可根据自己的需要配置）</p><pre><code>option /etc/ppp/options.pptpd 
logwtmp 
localip 172.16.0.1 
remoteip 172.16.0.2-254
</code></pre><p>localip：本机PPP网卡IP（作为客户端连接时的网关）</p><p>remoteip：客户端获取IP的范围（从2到254个IP顺序获取）</p><p>编辑VPN帐号密码信息：vim /etc/ppp/chap-secrets</p><p>格式为：登录帐号 协议 登录密码 指定客户端获取的IP</p><p>如：vpn pptpd vpn *  - 这样为帐号密码是vpn 获取的ip会从/etc/pptpd.conf配置的地址池中获取</p><p>vpn pptpd vpn 172.16.0.55 - 这样我就为该帐号设置了一个固定的IP，请不要设置123.3.4.5这样的IP 否则上不了网。</p><p>开启ipv4内核转发：vim /etc/sysctl.conf</p><p>把 net.ipv4.ip_forward = 0 修改为 net.ipv4.ip_forward = 1</p><p>执行 sysctl -p</p><p><a href=/images/2013/08/ipv4-forward.png><img src=/images/2013/08/ipv4-forward-300x201.png alt=ipv4-forward></a></p><p>现在我们的VPN服务基本已经配置完毕了，现在执行最后的操作</p><p>添加iptables NAT转发规则</p><pre><code>iptables -A INPUT -p tcp --dport 1723 -j ACCEPT

iptables -A INPUT -p tcp --dport 47 -j ACCEPT

iptables -A INPUT -p gre -j ACCEPT

iptables -t nat -A POSTROUTING -s 172.16.0.0/24 -o eth0 -j MASQUERADE
</code></pre><p>如果你的iptables策略并不需要如此严格其实添加下面这1条就可以了</p><pre><code>iptables -t nat -A POSTROUTING -s 172.16.0.0/24 -o eth0 -j MASQUERADE
</code></pre><p>保存iptables规则和启动pptp服务并设置开机启动</p><pre><code>service iptables save

service iptables restart

service pptpd start

chkconfig pptpd on
</code></pre><p>现在你就可以使用你的客户端连接到你的VPN服务开始翻X之旅啦！</p><p><a href=/images/2013/08/xen-pptp.png><img src=/images/2013/08/xen-pptp-266x300.png alt=xen-pptp></a></p><p>OpenVZ系统环境：CentOS release 6.2 (Final) 32位</p><p>安装ppp和pptp</p><pre><code>yum -y install ppp

rpm -ivh http://soft.painso.com/Linux/pptpd/pptpd-1.3.4-2.el6.i686.rpm
</code></pre><p>同样开始编辑配置文件：</p><pre><code>vim /etc/ppp/options.pptpd
</code></pre><p>清空粘帖下方配置</p><pre><code>name pptpd 
refuse-pap 
refuse-chap 
refuse-mschap 
require-mschap-v2 
require-mppe-128 
proxyarp 
lock 
nobsdcomp 
novj 
novjccomp 
nologfd 
ms-dns 8.8.8.8
ms-dns 8.8.4.4
</code></pre><pre><code>vim /etc/pptpd.conf
</code></pre><p>清空粘帖下方配置</p><pre><code>option /etc/ppp/options.pptpd
logwtmp
localip 172.16.0.1
remoteip 172.16.0.2-254
</code></pre><pre><code>vim /etc/ppp/chap-secrets
</code></pre><p>添加你的pptp服务帐号</p><p><a href=/images/2013/08/pptp.png><img src=/images/2013/08/pptp-300x55.png alt=pptp></a></p><p>同样修改内核配置开启ipv4转发</p><pre><code>vim /etc/sysctl.conf
</code></pre><p>里面的 net.ipv4.ip_forward=0 修改为 net.ipv4.ip_forward=1</p><pre><code>sysctl -p
</code></pre><p>添加iptables转发规则</p><pre><code>iptables -t nat -A POSTROUTING -s 172.16.0.0/24 -j SNAT --to-source 67.117.22.35
</code></pre><p>这里的 67.117.22.35 修改为服务器的公网IP</p><p>开启相关服务并开机启动</p><pre><code>service iptables save

service iptables restart

service pptpd start

chkconfig pptpd on
</code></pre><p>大功告成！</p><p><a href=/images/2013/08/openvz.png><img src=/images/2013/08/openvz-300x141.png alt=openvz></a></p><p>注：</p><p>错误1：如果出现错误619则输入命令：</p><pre><code>rm -r /dev/ppp
mknod /dev/ppp c 108 0
</code></pre><p>然后 reboot 重启。</p><p>错误2：如果出现错误800，这是因为虚拟机内核不支持mpPE，无法使用加密，用WINDOWS默认VPN连接会显示“证书信任错误”。解决方法：修改/etc/ppp/options.pptpd文件，在require-mppe-128字段前面加#即可，注释掉require-mppe-128这行就成功了</p><p>本地的windows系统的vpn属性改为可选加密，如下图：</p><p><a href=/images/2013/08/error.png><img src=/images/2013/08/error-300x227.png alt=error></a></p><p>其实到最后你会发现2种虚拟架构配置VPN只是添加到iptables的转发规则不同。</p><p><del>我操！浪费老子这么多时间，这Linux还怎么玩。。。</del></p></div><hr class=post-end><footer class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83.0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><path d="M7 7V7z"/></svg><span class=tag><a href=https://painso.com/tags/centos>CentOS</a></span><span class=tag><a href=https://painso.com/tags/linux>Linux</a></span><span class=tag><a href=https://painso.com/tags/openvz>OpenVZ</a></span><span class=tag><a href=https://painso.com/tags/vpn>VPN</a></span><span class=tag><a href=https://painso.com/tags/xen>Xen</a></span><span class=tag><a href=https://painso.com/tags/%E5%AE%89%E8%A3%85pptp>安装pptp</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2V8h6"/><path d="M16 13H8z"/><path d="M16 17H8z"/><path d="M10 9H9 8"/></svg></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><path d="M16 2V6z"/><path d="M8 2V6z"/><path d="M3 10H21z"/></svg>2013-08-14 14:25</p></footer></article><div class="post-nav thin"><a class=next-post href=https://painso.com/posts/tech/2013/centos-install-desktop/><span class=post-nav-label><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left"><path d="M19 12H5z"/><path d="M12 19 5 12l7-7"/></svg>&nbsp;</span><br><span>CentOS桌面环境安装</span></a>
<a class=prev-post href=https://painso.com/posts/tech/2013/change-mysql-password/><span class=post-nav-label>&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><path d="M5 12H19z"/><path d="M12 5l7 7-7 7"/></svg></span><br><span>修改mysql用户密码</span></a></div><div id=comments class=thin><div id=utter-container></div><script src=https://utteranc.es/client.js repo=ephz3nt/blog-comments issue-term=title theme=github-light crossorigin=anonymous async></script></div></main><footer id=site-footer class="section-inner thin animated fadeIn faster"><p>&copy; 2020 <a href=https://painso.com>ephz3nt</a> &#183; <a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank rel=noopener>CC BY-NC 4.0</a></p><p>Made with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> &#183; Theme <a href=https://github.com/Track3/hermit target=_blank rel=noopener>Hermit</a> &#183; <a href=https://painso.com/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"/><path d="M4 4a16 16 0 0 1 16 16"/><circle cx="5" cy="19" r="1"/></svg></a></p></footer><script src=https://painso.com/js/bundle.min.4a9a0ac3d2217822c7865b4161e6c2a71de1d70492264337755427898dd718f6.js integrity="sha256-SpoKw9IheCLHhltBYebCpx3h1wSSJkM3dVQniY3XGPY=" crossorigin=anonymous></script></body></html>